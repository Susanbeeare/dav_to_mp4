<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Conversor DAV → MP4 (FFmpeg.wasm 0.12, vía HTTP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--
    Este ejemplo requiere servirse por HTTP/HTTPS.
    Durante el desarrollo rápido ejecuta:
        npx http-server . -c-1 -o
    o bien:
        python -m http.server 8080  # Python ≥3

    Opcional (recomendado en producción): añade cabeceras COOP/COEP
      Cross-Origin-Opener-Policy: same-origin
      Cross-Origin-Embedder-Policy: require-corp
    para habilitar SharedArrayBuffer y ganar más memoria.
  -->
  <style>
    body { font-family: system-ui, sans-serif; max-width: 42rem; margin: 0 auto; padding: 1rem; }
    h1  { font-size: 1.4rem; }
    button { padding: .6rem 1rem; border: none; border-radius: .5rem; font-size: 1rem; cursor: pointer; background: #1366d6; color: #fff; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    progress { width: 100%; height: 1.2rem; margin: .75rem 0; }
    #log { white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: .75rem; border-radius: .4rem; height: 10rem; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>Convertir archivos .DAV a MP4 (servido por HTTP)</h1>

  <input type="file" id="uploader" accept=".dav" />
  <button id="convertBtn" disabled>Convertir a MP4</button>

  <progress id="progress" value="0" max="100" hidden></progress>
  <div id="log"></div>

  <script type="module">
    // Importamos FFmpeg desde jsDelivr (envía CORS OK);
    // al servirse este HTML por HTTP, crear el Worker ya no será bloqueado.
    import { FFmpeg } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/esm/index.js";

    // Instancia sin trucos: FFmpeg buscará automáticamente worker.js y core en el mismo CDN
    const ffmpeg = new FFmpeg();

    // Helper para leer File/Blob/URL → Uint8Array
    const fetchFile = async (src) => {
      if (src instanceof File || src instanceof Blob) {
        return new Uint8Array(await src.arrayBuffer());
      }
      const res = await fetch(src);
      return new Uint8Array(await res.arrayBuffer());
    };

    // Elementos de la UI
    const uploader   = document.getElementById("uploader");
    const convertBtn = document.getElementById("convertBtn");
    const progressEl = document.getElementById("progress");
    const logBox     = document.getElementById("log");
    const log = (msg) => { logBox.textContent += msg + "\n"; logBox.scrollTop = logBox.scrollHeight; };

    const loadFFmpeg = async () => {
      if (!ffmpeg.loaded) {
        log("Descargando núcleo FFmpeg…");
        await ffmpeg.load({ log: true });
        log("FFmpeg listo ✔️");
      }
    };

    uploader.addEventListener("change", () => {
      convertBtn.disabled = !uploader.files.length;
    });

    convertBtn.addEventListener("click", async () => {
      const file = uploader.files?.[0];
      if (!file) return;

      convertBtn.disabled = true;
      progressEl.hidden = false;
      progressEl.value = 0;
      logBox.textContent = "";

      try {
        await loadFFmpeg();

        ffmpeg.on("progress", ({ progress }) => {
          progressEl.value = Math.round(progress * 100);
        });

        // Escribir .DAV en FS virtual
        await ffmpeg.writeFile(file.name, await fetchFile(file));
        log(`Archivo recibido: ${file.name}`);

        const output = "salida.mp4";
        log("Convirtiendo (copia de streams)…");
        await ffmpeg.exec(["-i", file.name, "-c", "copy", output]);
        log("Conversión terminada ✔️");

        // Descargar resultado
        const data = await ffmpeg.readFile(output);
        const url = URL.createObjectURL(new Blob([data.buffer], { type: "video/mp4" }));
        const a = document.createElement("a");
        a.href = url;
        a.download = file.name.replace(/\.dav$/i, "_convertido.mp4");
        a.textContent = "Descargar MP4";
        a.style.display = "block";
        a.style.marginTop = "1rem";
        document.body.appendChild(a);

        // Limpieza
        await ffmpeg.deleteFile(file.name);
        await ffmpeg.deleteFile(output);
      } catch (err) {
        console.error(err);
        log("❌ Error: " + err.message);
        log("Asegúrate de estar sirviendo la página por HTTP y de tener conexión a internet.");
      } finally {
        progressEl.hidden = true;
        convertBtn.disabled = false;
      }
    });

    // Liberar memoria al cerrar pestaña
    window.addEventListener("beforeunload", () => ffmpeg.terminate());
  </script>
</body>
</html>
